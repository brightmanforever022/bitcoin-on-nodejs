进行中...

# 架构设计

## 前言

区块链是加密货币背后的技术，是当下与VR等比肩的热门技术之一。最初接触区块链的小伙伴，感觉非常茫然，无从下手，原因是区块链本身不是什么新技术，类似于Ajax，说它是一种技术架构，或许更加确切。所以，这篇文章我们就从架构设计的角度，谈谈区块链的技术实现，无论你擅长什么编程语言，都能够参考这种设计去实现一款区块链产品。当然，具体到产品，架构设计有很多种，不同的人、不同的产品，架构设计也不尽相同，我们这里仅仅从亿书的架构说起，提供一种参考，让读者能够直观的感受区块链的技术实现。

## 基本概念

区块链的概念最近很火，它来自于比特币等加密货币的实现，但是目前，这项技术已经逐步运用在各个领域。什么是区块链技术？为了感性认识这个问题，我们可以使用谷歌地球的例子做类比，ajax不是什么新技术，但组合在一起就成就了产品谷歌地球，与之类似，区块链也不是什么新技术，但与加密解密技术、P2P网络等组合在一起，就像ajax一样诞生了比特币。技术人员，特别是Web开发工程师，学习了解ajax技术最早是被谷歌地球酷炫的效果所吸引。而现在，历史再一次重演，很多人被比特币的疯狂发展所吸引，进而开始研究其背后的技术——区块链。

区块链原本是比特币等加密货币存储数据的一种独特方式，是一种自引用的数据结构，存储的数据是公开、透明、可追溯的。实际上，这种特性也直接体现了整个加密货币的思想，因此使用区块链来概括加密货币背后的技术实现是非常直观和恰当的。所以，目前当大家单独说到区块链的时候，就是指的区块链技术，是实现了数据公开、透明、可追溯的产品的架构设计方法，算作广义的区块链。而当在具体产品中谈到区块链的时候，可以指类似比特币的数据存储方式，或许是数据库设计，或许是文件形式的设计，这算作狭义的区块链。

广义的区块链技术，必须包含点对点网络设计、加密技术应用、分布式算法的实现、数据存储技术的使用等4个方面，其他的可能涉及到分布式存储、机器学习、VR、物联网、大数据等。狭义的区块链仅仅涉及到数据存储技术，数据库或文件操作等。本文的区块链，指的是广义的区块链。

## 架构图

从架构设计上来说，区块链可以简单的分为三个层次，协议层、扩展层和应用层。其中，协议层又可以分为存储层和网络层，它们相互独立但又不可分割。如图：

![blockchain_overview.png][]

## 解读

#### （1）协议层

所谓的协议层，通常就是指代最底层的技术。这个层次就是一个完整的加密货币，类似于我们电脑的操作系统，它提供的可供用户使用的软件，最多就是一个客户端钱包。这个客户端钱包功能也很简单，只能建立地址、验证签名、转账支付、查看余额等。这个层次是一切的基础，相当于构建了网络环境、搭建了交易通道，至于你要交易什么，想干什么，它一概不过问，也过问不了。典型的例子，自然是比特币，还有各种二代币，比如莱特币、狗狗币等，本书介绍的亿书币也是。这个层次，是现阶段开发者聚集的地方，这说明加密货币仍在起步当中。

从用到的技术来说，这个层面主要包括网络编程、分布式算法、加密签名、数据库技术等4个方面，其中网络编程能力是大家选择编程语言的主要考虑因素，因为分布式算法基本上属于业务逻辑上的实现，什么语言都可以做到，加密签名技术是直接简单的使用（请看书中相关的加密解密文章，不建议自由发挥，所以没有过多的编码逻辑），数据库技术选择自由度大一些，但主要在使用层面，只有点对点网络的实现和并发处理才是开发的难点，所以对于那些网络编程能力强，对并发和回调处理更加简单的语言，人们就更加偏爱。也因此，Nodejs开发区块链应用，非常流行，go语言也在逐渐兴起。

#### （2）扩展层

这个层面类似于电脑的驱动程序，是为了让加密货币更加实用。一是各类轻钱包应用，让不同用户可以选择不同的钱包，应该算作简单的扩展实现。二是各类交易市场，是法币兑换加密货币的重要渠道，实现简单，来钱快，成本低，但风险也大。三是针对某个方向的扩展实现，比如sia属于去中心化的存储，以太坊属于智能合约，亿书专注于数字出版等。特别值得一提的就是大家听得最多的“智能合约”的概念，这是典型的扩展层面的应用开发。所谓“智能合约”就是“可编程合约”，或者叫做“合约智能化”，其中的“智能”是执行上的智能，也就是说达到某个条件，合约自动执行，比如自动转移证券等，目前还没有比较成型的产品，但不可否认，这将是区块链技术重要的应用方向。

扩展层的技术可以包括很多，上面提到的分布式存储、机器学习、VR、物联网、大数据等等，都可以使用了。编程语言的选择上，可以更加自由，甚至可以与协议层完全分离，编程语言也可以不相同。这个层面与应用层更加接近了，除了在交易时与协议层进行交互之外，其他时候尽量不要与协议层的开发混在一起。这样不仅在架构设计上更加科学，让区块链数据更小，网络更独立，同时也可以保证扩展层不受约束。

#### （3）应用层

这个层面类似于电脑中的各种软件程序，是老百姓可以真正直接使用的产品。这个层面的应用，目前几乎是空白。市场亟待出现这样的应用，引爆市场，形成真正的扩张之势，让加密货币快速走进寻常百姓。

本书写作和分享亿书源码的目的，就是要打造一个人人可用的去中心化的软件——亿书。亿书基于加密货币——亿书币（本书源码分享部分），扩展了侧链功能，提供了一个简单的写作工具，用以满足人们日常工作需要。它强大的协作功能、数字出版、版权保护，以及侧链功能等，对于专业作者、博客写手和开发者具有足够吸引力。

限于当前加密货币的发展，亿书只能从基础层出发，把目标指向应用层，同时为第三方开发者提供扩展层的强大支持。这样做既可以避免贪多，又可以避免无法落地，是真正理性的开发路线。因为纯粹的开发基础层或扩展层，无法真正理解和验证应用层，会脱离实际，让第三方开发者很难使用。如果仅仅考虑应用层，市面上又找不到真正牢固、易用的基础层或扩展层的产品，包括那些众筹成功的，也仅仅停留在概念层面，导致开发成本高，风险大。


[blockchain_overview.png]: ../styles/images/third/blockchain_overview.png
