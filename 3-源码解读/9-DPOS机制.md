进行中...

# DPOS机制的实现

## 前言

共识机制，这可是我一直神往的部分。我在第一个部分，专门拿出一篇文章介绍了它的原理、作用和种类，这一篇我们就来探讨在币圈同样火热的算法问题“拜占庭将军问题”，并通过代码学习和研究亿书共识机制的具体实现。

## 源码

主要源码地址：

delegates.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/delegates.js

round.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/round.js

accounts.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/accounts.js

slots.js: https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/helpers/slots.js

## 类图

![dpos-class.png][]

## 流程图

![dpos-activity.png][]

## 解读

我们在第一部分《共识机制，看编程的“利益”转移规则》里，已经详细解释了共识机制的相关概念，也对比了当前加密货币领域常用的三种共识算法原理和优越点，阅读本篇内容前，可以先去浏览温习一下。

#### 拜占庭将军问题

（1）比特币是为解决拜占庭将军问题而做的原型产品吗？

这里咱也八卦一下，猜猜比特币如何诞生的。在学习一门新技术的时候，我们通常会好奇，发明这项新技术的人，他是怎么想到要进行这项发明的呢？同样，对于比特币，我也曾经好奇，中本聪怎么想到要发明比特币的呢？这大量高科技的应用，可不是个小工程，一定要有明确的目的才行。这种好奇，始终督促我不断研究下去。

算法是解决问题的理论基础，拜占庭将军问题就是针对分布式共识算法提出来的，而这个问题也是比特币等加密货币的核心问题。根据比特币白皮书（其实就是一篇科技论文）内容描述，大量篇幅提到诚实节点、攻击者等问题，类似于古代战场攻防对战，很多人猜测中本聪或许就是一位专门研究这个方向的大学老师或研究人员，他解决了这个问题，推出了相关论文，并根据研究成果写出了产品原型——比特币。所以，才会说比特币仅仅是一项实验。

显然，这种猜测，纯属马后炮，由结果找原因，毫无历史根据。网上搜索了一下，各种猜测还真不少。姑且避开八卦内容，其中比较有价值的，是一篇比特金（Bit Gold）白皮书，因为它与比特币有惊人的相似之处，因此其开发者尼克·萨博（Nick Szabo）被认为最有可能是中本聪本人。比特金比比特币要早，它的目标就是实现一种不需要（只需极小的）信用中介的电子支付系统，与比特币的目标基本一致。

所以，比特币的初衷并非单纯为了解决拜占庭将军问题而制作的原型产品，而是为了实现没有中介的电子支付系统而设计的产品，只不过附带完美的解决了拜占庭将军问题而已。事实上，通过使用点对点网络、加密解密技术实现加密货币的研究由来已久，比特币仅仅是一个成功的实现。

（2）什么是拜占庭将军问题？

但不管怎么说，拜占庭将军问题是比特币无法逾越的问题，最早是由Leslie Lamport在研究中编出的一个故事。故事是这样的：拜占庭是东罗马帝国的首都，为了防御外敌入侵，周边驻扎了军队，而且每个军队都分隔很远，相互独立，将军与将军之间只能靠信差传递消息。在战争的时候，拜占庭军队内所有将军必需达成一致的共识（进攻或撤退）。但是，在军队内部有可能存在叛徒，左右将军们的决定。这时候，在已知有成员谋反的情况下，其余忠诚的将军如何达成一致的协议，拜占庭问题就此形成。Lamport 证明了在理想状态下，将军总数大于3m ，背叛者为m或者更少时，忠诚的将军可以达成命令上的一致。

从技术上理解，拜占庭将军问题是分布式系统容错性问题。加密货币建立在P2P网络之上，是典型的分布式系统，类比一下，将军就是P2P网络中的节点，信使就是节点之间的通信，进攻还是撤退的决定就是需要达成共识的信息。如果某台独立的节点计算机拓机、掉线或攻击网络搞破坏，整个系统就要停止运行，那这样的系统将非常脆弱，所以容许部分节点出错或搞破坏而不影响整个系统运行是必要的，这就需要算法理论上的支撑，保证分布式系统在一定量的错误节点存在的情况下，仍然保持一致性和可用性。

我非常赞同把拜占庭将军问题与两军问题分开，两个问题的本质不同，后者重在研究信差的通信问题，类似于TCP协议的握手操作，原则上是没有解的。而拜占庭将军问题是假定信差没有问题，只是将军出现了叛变等问题，所以二者本质有区别。不过，在实际的加密货币系统里，信差的问题，比如通信中断、被劫持等，都可以归为将军（节点）出了问题，理解到这一点就可以了，因此可以说比特币是完美解决了这两个问题。关于两者的区别，请看这篇文章《拜占庭将军问题深入探讨》（见附件），作者下了不少功夫，值得一读。

（3）比特币是如何解决拜占庭将军问题的？

Lamport 给出了理想状态下的答案，但现实是复杂的，比特币是如何解决的呢？其中，这样几个因素起到了显著的作用：

**首先，通过“工作量证明”，维持一个固定循环周期**。比特币每产生一个区块的间隔大概是10分钟，这是通过“工作量证明”（PoW）机制智能限定的。比特币有一个算法难度，会根据全网算力情况自动调整，以保证网络一直需要花费10分钟来找到一个有效的哈希值。在这10分钟以内，网络上的参与者发送信息并完成交易。这会防止将军们无限制的发送命令，一切都在这个时间段内完成。

**其次，通过时间戳和电子签名，确保有效信息单节点广播**。某节点“工作量证明”完成之后，结束一个新区块，可以立即广播到网络。比特币客户端可以方便的进行公钥验证和私钥签名，从而其他节点可以迅速验证并结束该轮次的竞赛，自觉进入下一轮。这种时间戳和加密解密技术的应用确保比特币系统在某一个时间点只有一个（或几个）节点传输信息，改变了将军们互相传送的混乱。

**最后，通过使用区块链，始终维持一个公共总账**。基于P2P网络的BT技术是成熟的，同步一个总帐是很简单的事情。网络中的节点，在每个循环周期内都是同步的，这让每个将军做决策的时候就有了共同的基础。如果每个节点都维护自己的账本，那问题的复杂性将无法想象。

然后，再加上其他的一些奖励机制，完整的比特币系统便迅猛发展起来。

#### 亿书DPOS（授权股权证明）机制概述

[亿书白皮书][] 描述了DPOS（授权股权证明）机制基本原理和改进方法，这里不再重复。亿书由受托人来创建区块，并定量增加新币（铸币奖励，第一年每个块奖励5个亿书币），从而保证整个网络安全运行。整个机制需要完成如下过程：

（1）注册受托人，并接受投票

- 用户注册为受托人;
- 接受投票（得票数排行前101位）;

（2）维持循环，调整受托人

- 时段周期（Slot）：也称为块周期，每个块需要10秒，为一个时段（Slot）；
- 循环周期（Round）：或叫受托人周期，每101个区块为一个循环周期（Round）。这些块均由101个代表随机生成，每个代表生成1个块。一个完整循环周期大概需要1010秒(101x10)，约16分钟；每个周期结束，前101名的代表都要重新调整一次；
- 奖励周期（Milestone）：根据区块链高度，设置里程碑时间，在某个时间点调整区块奖励。大致是这样的，第一年奖励5亿书币/块，4年之后降为1亿书币/块，以后永远保持1亿书币/块，所以总量是在少量增发的；

（3）循环产生新区块，处理分叉

上一章《区块链》已经讲过，不再赘述。

下面，我们通过源码逐个查看其实现方法。

#### 1.注册受托人

注册受托人必须使用客户端软件（币圈俗称钱包），因此这项功能需要与节点进行交互，也就是说客户端要调用Api。与受托人管理的模块是 modules/delegates.js ，根据前面篇章的经验，我们很容易找到该模块提供的Api：

```
"put /": "addDelegate"
```

最终的Api信息如下：

```
put /api/delegates
```

对应的方法是，modules/delegates.js模块的`addDelegate()`方法。该方法与注册用户别名地址等功能性交易没有区别，注册受托人也是一种交易，类型为“DELEGATE”（受托人），详细过程请自行查看modules/delegates.js文件1017行的源码。

#### 2.投票



#### 3.时段周期

#### 4.循环周期（Round）

#### 5.奖励周期（Milestone）


## 链接

**本系列文章即时更新，若要掌握最新内容，请关注下面的链接**

本源文地址： https://github.com/imfly/bitcoin-on-nodejs

亿书白皮书： http://ebookchain.org/ebookchain.pdf

亿书官网： http://ebookchain.org

亿书官方QQ群：185046161（亿书完全开源开放，欢迎各界小伙伴参与）

## 参考

[比特币白皮书：一种点对点的电子现金系统](http://www.8btc.com/wiki/bitcoin-a-peer-to-peer-electronic-cash-system)

[尼克·萨博《比特金（BitGold）》白皮书](http://www.8btc.com/bit-gold)

[百度百科关于拜占庭将军问题描述](http://baike.baidu.com/link?url=BMJl6w7U9VWdYVpMS5OqG-y3m1Ez6g8b0-PygRuCg2S65Al72y382s6Nuqhc1zCmclXzoFOALMIwimMd1dTCVa)

[分布式共识难题（英文）](https://en.wikipedia.org/wiki/Consensus_(computer_science))

[拜占庭将军问题深入探讨](http://www.8btc.com/baizhantingjiangjun)

[stackoverflow](http://stackoverflow.com/questions/17502948/nexttick-vs-setimmediate-visual-explanation).

[dpos-class.png]: ../styles/images/modules/dpos/dpos-class.png
[dpos-activity.png]: ../styles/images/modules/dpos/dpos-activity.png
[dpos-database.png]: ../styles/images/modules/dpos/dpos-database.png
