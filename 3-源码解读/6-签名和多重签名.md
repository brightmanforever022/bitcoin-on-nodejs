进行中...

# 签名和多重签名

## 前言

在上一篇《地址》文章里，我们把验证部分的代码都隐去了，没有了大量的验证逻辑，阅读用户帐号相关的业务流程就变得轻松很多。在实际的开发中，很多程序员也习惯于从简单的业务功能入手，逐步添加更多的验证和功能，这种行为俗称“增量开发”。

被隐去的这部分代码，就是本篇文章要介绍的签名和多重签名。本篇，我们从介绍基本概念开始，了解签名的作用和代码实现，为下一篇《交易》的介绍做好铺垫。

## 源码

主要源码地址：

signatures.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/signatures.js

multisignatures.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/multisignatures.js

## 类图

`签名`方法在`modules/signatures.js`文件里，类图如下：

![signatures-class.png][]

`多重签名`方法在`modules/multisignatures.js`文件里，类图如下：

![multisignatures-class.png][]

## 解读

#### 签名

`签名`是什么？这是我们首先应该弄明白的。这个概念，网上有很多，大家可以参考。我个人理解的“签名”，与我们日常生活中的签名，在作用和目的上是一样的，仅仅是具体方法不同而已。

日常生活中，凡是需要确认归属的（是签名人的，不是其他的。我签名了，这个文件就是我签发的，责任我负;这个支票就要由我支付），都需要所有者进行签名。我们普通老百姓最常见的就是去银行办业务，银行职员会让你反复签一大堆的单子，想必每个人都会有深刻的印象。

人的笔迹是很个性化的，越熟练个性特征越固定，因此一个人的名字，不同的人写出完全相同的笔迹的几率非常小，即便是专业模仿也可能通过技术鉴别出来，这样一来，人的`签名`就具有唯一性、可验证的特点，并被法律认可。

如果，你拿着一张支票去银行兑换，银行职员会对支票上的签名和印章仔细比对，确保印章大小、样式，以及付款人签名等，都与银行留存的信息一致，才会给你兑付，这就是`签名`验证。

通过上述分析，可以理解的是，`签名`的作用是确定资产所属，其特征是简单、安全、可验证。把这个概念抽象出来，应用到计算机系统里，为了确定网络资源（比如比特币地址、电子书版权等）所属，也需要进行电子`签名`，具体方法只能使用加密技术，不然任何签名方法都会被模仿，而且模仿的成本极低，相反，验证的成本却很高。具体的加密或验证技术，请参考前面的章节。

这里，还有一个问题需要思考清楚，那就是什么资产需要`签名`。如果了解比特币客户端，我们都知道，它提供了一个消息签名的功能，可以用来对其他用户通过比特币网络之外的信息进行验证。

举个简单的例子，Alice开了一个网店，但并没有直接接入比特币网络（不能自动确认和验证支付者）。客户Imfly要购买她的产品，并用比特币支付了全部货款。现在，Alice需要确认Imfly提供的那个付款地址确实是他的，才能发货。这时候，就需要Imfly先把支付货款的比特币地址和相关交易信息`签名`，然后通过QQ等传给Alice，Alice使用客户端验证`签名`信息，才能确认交易确实是Imfly的。

想象一下，如果没有`签名`功能会怎么样呢？因为比特币是匿名的，它保证了资金安全有效的支付，但却无法确认支付方或收款方是谁，信息的不确定性，将让交易无法达成。在中心化的世界里，这个问题是通过平台这个第三方达成的，比如支付宝等，双方的全部信息，平台都掌握，任何一方出现欺诈，都可以通过向平台投诉来解决。用户通过牺牲个人信息匿名性获得了基本保障。

因此，在网络空间里，`签名`可以对任何需要确认的数字信息进行处理，并以此来宣告重要资产的所属。

亿书也具备签名能力，只不过，目前还没有单独提供`签名`各种信息的功能供用户使用，而是通过签名，添加`支付密码`功能，对用户帐号资产追加了一层保护。

#### 支付密码

我们还是从Api开始，代码如下：

```
// modules/signatures.js文件
// 179行
router.map(shared, {
  "get /fee": "getFee",
  "put /": "addSignature"
});

// 188行
library.network.app.use('/api/signatures', router);
```

通过上面的代码，可以了解`签名`提供了两个简单的公共接口：

```
get /api/signatures/fee -> shared.getFee
put /api/signatures/ -> shared.addSignature //签名操作
```

显然，最核心的方法也就是`shared.addSignature`，代码：

```
// 215行
shared.addSignature = function (req, cb) {
	...
	library.scheme.validate(body, {
		properties: {
			...
		},
		required: ["secret", "secondSecret"]
	}, function (err) {
		...

		library.balancesSequence.add(function (cb) {
			if (body.multisigAccountPublicKey && body.multisigAccountPublicKey != keypair.publicKey.toString('hex')) {
				modules.accounts.getAccount({publicKey: body.multisigAccountPublicKey}, function (err, account) {
					...

						try {
							var transaction = library.logic.transaction.create({
								type: TransactionTypes.SIGNATURE, // 297行
								sender: account,
								keypair: keypair,
								requester: keypair,
								secondKeypair: secondKeypair,

							});
						} catch (e) {
							return cb(e.toString());
						}
            ...			
}
```

毫无疑问，`支付密码`也是一个简单的交易（交易类型`TransactionTypes.SIGNATURE`，见297行）。基于此，我们不难想象，添加类似比特币的`签名`也是件非常简单的事情，我们会在下一个版本里添加这项功能，具体请关注 [亿书币版本库][] 最新进展。

#### 多重签名

就是一个简单加密过程，验证也变得简单高效。

## 链接

**本系列文章即时更新，若要掌握最新内容，请关注下面的链接**

本源文地址： https://github.com/imfly/bitcoin-on-nodejs

电子书阅读： [http://bitcoin-on-nodejs.ebookchain.org](http://bitcoin-on-nodejs.ebookchain.org/3-源码解读/6-签名和多重签名.html)

## 参考

[亿书白皮书 http://ebookchain.org/ebookchain.pdf](http://ebookchain.org/ebookchain.pdf)

[亿书白皮书]: http://ebookchain.org/ebookchain.pdf

[亿书币版本库]: https://github.com/Ebookcoin/ebookcoin

[signatures-class.png]: ../styles/images/modules/signatures/signatures-class.png

[multisignatures-class.png]: ../styles/images/modules/signatures/multisignatures-class.png
