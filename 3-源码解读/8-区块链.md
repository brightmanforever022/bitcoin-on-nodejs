进行中...

# 区块链

## 前言

比特币诞生以来，经过7个年头的发展，加密货币从小众的玩具，到世界各国的围追堵截，再到今天各大公司的参与和追捧，其中最令各国恐惧阻挠的原因是区块链，最令人神往的也是因为区块链。同样，为什么要写这本书，为什么要把版权保护和知识分享建立去中心化的架构之上，原因还是区块链。

我们分享的源码项目——亿书，是一款加密货币产品，用时髦的话说，更是一款实用的区块链产品。那么，区块链是什么？有那些非比寻常的特点？这一章，我们就来详细解释和说明，并把亿书相关的代码逻辑，认真阅读和理解，以便更加深入的了解和掌握这项技术。

## 源码

blocks.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/blocks.js

block.js https://github.com/Ebookcoin/ebookcoin/blob/logic/block.js

loader.js https://github.com/Ebookcoin/ebookcoin/blob/v0.1.3/modules/loader.js

## 类图

![blocks-class.png][]

## 流程图

![blocks-activity.png][]

## 解读

#### 1.区块链是什么？

区块链是去中心化的公开账本，由包含交易信息的区块从后向前有序链接起来的数据结构，可以存储成文件形式，不过多数产品存储在一个数据库中，比如比特币使用Google的LevelDB数据库存储。

（1）从数据库设计角度理解区块链

用数据库的概念理解，区块链就是一张“自引用”的数据库表。每条记录代表一个区块，这条记录（区块）记录着它前面（时间上）一条记录的信息，可以直接查询到前一条记录，因此从任何一条记录开始都可以往前顺序追溯，直到第一条记录。普通自引用表结构，通常使用ID作为关联外键，加密货币使用的是经过加密处理的信息字段，称为区块头信息，通常包含更多信息。

与区块链直接关联的另一张重要的表，就是交易表。加密货币包含大量的交易，交易记录通常保存在一张独立表里，并与区块链形成多对一的关联方式。如此以来，只要追溯到区块，就很容易查询到该区块包含的交易记录。

每一个区块都与它的前一区块（父区块）关联，而对它后面的区块（子区块）无限制，也就是说最顶端的区块，肯定知道它的父区块（已经写入区块链），但不知道子区块（或许还没有产生，也可能在传输的网络中）。我们知道，数据库、硬盘、网络的IO操作是最耗费时间成本的，在某一个时刻，多个最新区块（两个的几率最高）同时找到父区块是再正常不过的现象，这就是所谓的区块链分叉。

显然，区块链分叉是物理环境决定的，这与什么样的共识机制没有直接关系，不论是采取工作量证明机制（PoW)的比特币、还是采取股权证明机制（PoS）的点点币，亦或是这里采取授权股权证明机制（DPoS）的亿书币，都是如此。为了保持区块链的单一链条，解决分叉的最简单方式就是让每个分叉继续增长，最长的那个获胜。在具体的设计开发过程中，这也是一个逻辑相对复杂的难点。

（2）形象化理解区块链

人们通常把具有先后顺序的数据结构，使用栈来表示，比特币白皮书把这种结构进一步形象化，第一个区块作为栈底，然后其他区块按照时间顺序依次堆叠在上面，这样一来，区块与首区块之间的距离就表示“高度”，“顶端”就表示最新添加的区块。每个区块包含大量交易，就是包含在对应栈里的数据。于是，我们可以把区块链想象成下面这样：

![stack-drawers.png][]

区块链好比一个大大的橱柜，区块就其中一个抽屉，抽屉里是交易。

#### 2.区块链的特点

我们可以按照堆栈的方式理解数据结构，并采用自引用的关联方式设计数据库模型，但是做到这些，我个人认为并不代表就是区块链了，它还必须被置于去中心化的网络，由P2P网络节点共同维护，才能称得上区块链。

当然，也有人持不同观点，他们认为一个中心化的应用，如果使用类似的数据结构，会更加安全（比不使用该结构的中心化系统），同时因为避免了分叉，性能或许更高（比去中心化的系统），但事实上没有了P2P网络的支撑，这点改进算不上什么。

我们之前分析过，P2P网络本身就是一条非常好的安全屏障，单点被攻击或被破解，对整个网络系统没有太大伤害，而任何中心化的系统仅仅相当于单节点，安全性大大降低。所以，相对那些许的性能改进，牺牲掉更加稳固的安全性，有点得不偿失。

汇总以上信息，区块链应该具备这样几个特点：

* 分布存储：区块链处于P2P网络之中，无论什么公链、私链，还是联盟链，都要采取分布式存储，使用一种机制保证区块链的同步和统一;
* 公开透明：每个节点都有一个数据库副本，数据可以任意查询;
* 无法篡改：每一区块都会记录前一区块的加密区块头信息，并实现追溯和验证，确保无法篡改;
* 存在分叉：这是P2P网络决定的。

也正是因为这样的特点（特别是前三个），区块链的概念才逐渐火爆起来。区块链可以解决很多中心化应用无法解决的问题，特别是对于金融业而言，电子支付、资金清算、审计等等，成本会大幅度降低。而亿书，利用它公开透明、可追溯的特点，与数字出版结合起来，彻底解决当前数字出版版权保护不力的顽疾。

#### 3.亿书区块链数据库设计

与区块链相关的数据库结构如图：

![blocks-database.png][]

#### 4.区块头信息处理

产生c结尾的地址：

```
// logic/block.js 20行
private.getAddressByPublicKey = function (publicKey) {
	var publicKeyHash = crypto.createHash('sha256').update(publicKey, 'hex').digest();
	var temp = new Buffer(8);
	for (var i = 0; i < 8; i++) {
		temp[i] = publicKeyHash[7 - i];
	}

	var address = bignum.fromBuffer(temp).toString() + "C";
	return address;
}

// 上面的方法，在312行dbRead函数里调用，
generatorId: private.getAddressByPublicKey(raw.b_generatorPublicKey),
```

## 总结

## 链接

## 参考

[从数据库发展规律看区块链技术](http://chainb.com/?P=Cont&id=33)
[http://www.8btc.com/what-is-blockchain](http://www.8btc.com/what-is-blockchain)
[区块链的运行原理和发展](http://www.8btc.com/blockchain-principle)

[blocks-class.png]: ../styles/images/modules/blocks/blocks-class.png
[blocks-activity.png]: ../styles/images/modules/blocks/blocks-activity.png
[stack-drawers.png]: ../styles/images/third/drawers2.png
[blocks-database.png]: ../styles/images/modules/blocks/blocks-database.png
